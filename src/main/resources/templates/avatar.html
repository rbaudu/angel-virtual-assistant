<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle ?: 'Angel Virtual Assistant'}">Angel Virtual Assistant</title>
    
    <!-- Styles extraits dans un fichier CSS s√©par√© -->
    <link rel="stylesheet" th:href="@{/css/avatar.css}">
	<link rel="stylesheet" th:href="@{/css/wake-word-detector.css}">
	<link rel="icon" type="image/x-icon" th:href="@{/assets/images/favicon.ico}">
	<link rel="shortcut icon" type="image/x-icon" th:href="@{/assets/images/favicon.ico}">
    
    <!-- Meta tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Interface web pour Angel Virtual Assistant">
</head>
<body class="avatar-fullscreen">
    <!-- Container principal de l'avatar -->
    <div id="avatar-container">
        <!-- Zone de rendu 3D -->
        <div id="avatar-viewport">
            <div class="loading-spinner" id="loading-spinner"></div>
            <div class="speaking-indicator" id="speaking-indicator"></div>
        </div>

        <!-- Bulle de message -->
        <div id="message-bubble">
            <p id="message-text">Bonjour ! Je suis Angel, votre assistant virtuel.</p>
        </div>

        <!-- Contr√¥les de l'avatar -->
        <div id="avatar-controls">
            <button class="control-button" id="mute-btn" title="Couper/Activer le son">
                üîä
            </button>
            
            <div id="avatar-status">En attente...</div>
            
            <button class="control-button" id="settings-btn" title="Param√®tres">
                ‚öôÔ∏è
            </button>
        </div>
    </div>

	<!-- Interface vocale -->
	<div class="voice-interface">
	    <!-- Indicateur d'√©coute -->
	    <div id="listening-indicator" class="idle" title="√âtat de reconnaissance vocale">
	        üé§
	    </div>
	    
	    <!-- Contr√¥les vocaux -->
	    <div class="voice-controls">
	        <button id="start-listening" class="voice-control-btn start" title="D√©marrer l'√©coute">
	            ‚ñ∂Ô∏è
	        </button>
	        <button id="stop-listening" class="voice-control-btn stop" title="Arr√™ter l'√©coute">
	            ‚èπÔ∏è
	        </button>
	        <button id="voice-settings" class="voice-control-btn settings" title="Param√®tres vocaux">
	            ‚öôÔ∏è
	        </button>
	    </div>
	    
	    <!-- Panneau de configuration vocale -->
	    <div id="voice-settings-panel" class="voice-settings-panel">
	        <button class="close-settings" id="close-settings">√ó</button>
	        <h3>Param√®tres de reconnaissance vocale</h3>
	        
	        <div class="voice-setting">
	            <label for="wake-word-input">Mot-cl√© :</label>
	            <input type="text" id="wake-word-input" value="Angel" />
	        </div>
	        
	        <div class="voice-setting">
	            <label for="language-select">Langue :</label>
	            <select id="language-select">
	                <option value="fr-FR">Fran√ßais</option>
	                <option value="en-US">English (US)</option>
	                <option value="en-GB">English (UK)</option>
	                <option value="es-ES">Espa√±ol</option>
	                <option value="de-DE">Deutsch</option>
	            </select>
	        </div>
	        
	        <div class="voice-setting">
	            <label for="confidence-slider">Seuil de confiance : <span id="confidence-value">0.7</span></label>
	            <input type="range" id="confidence-slider" min="0.1" max="1.0" step="0.1" value="0.7" />
	        </div>
	        
	        <div class="voice-setting">
	            <label>
	                <input type="checkbox" id="continuous-listening" checked />
	                √âcoute continue
	            </label>
	        </div>
	        
	        <div class="voice-setting">
	            <label>
	                <input type="checkbox" id="debug-mode" />
	                Mode debug
	            </label>
	        </div>
	    </div>
	    
	    <!-- Statut de reconnaissance vocale -->
	    <div id="speech-status" class="speech-status">
	        Initialisation...
	    </div>
	</div>

	<!-- Message d'avertissement navigateur -->
	<div id="browser-warning" class="browser-warning">
	    <h4>‚ö†Ô∏è Navigateur non compatible</h4>
	    <p>Votre navigateur ne supporte pas la reconnaissance vocale. Veuillez utiliser Chrome, Edge ou Safari.</p>
	    <button onclick="this.parentElement.style.display='none'">Fermer</button>
	</div>
	
    <!-- Overlay pour les param√®tres -->
    <div id="settings-overlay"></div>

    <!-- Panneau de param√®tres -->
    <div id="avatar-settings">
        <h3 class="settings-title">Configuration de l'Avatar</h3>
        
        <div class="setting-group">
            <label class="setting-label" for="gender-select">Genre :</label>
            <select class="setting-select" id="gender-select">
                <option value="female">Femme</option>
                <option value="male">Homme</option>
            </select>
        </div>
        
        <div class="setting-group">
            <label class="setting-label" for="age-select">√Çge :</label>
            <select class="setting-select" id="age-select">
                <option value="25">25 ans</option>
                <option value="30" selected>30 ans</option>
                <option value="35">35 ans</option>
                <option value="40">40 ans</option>
                <option value="50">50 ans</option>
                <option value="60">60 ans</option>
            </select>
        </div>
        
        <div class="setting-group">
            <label class="setting-label" for="style-select">Style :</label>
            <select class="setting-select" id="style-select">
                <option value="casual" selected>D√©contract√©</option>
                <option value="professional">Professionnel</option>
                <option value="friendly">Amical</option>
                <option value="elegant">√âl√©gant</option>
            </select>
        </div>
        
        <div class="setting-group">
            <label class="setting-label" for="voice-select">Voix :</label>
            <select class="setting-select" id="voice-select">
                <option value="female_french_warm" selected>Femme - Chaleureuse</option>
                <option value="female_french_professional">Femme - Professionnelle</option>
                <option value="male_french_warm">Homme - Chaleureux</option>
                <option value="male_french_professional">Homme - Professionnel</option>
            </select>
        </div>
        
        <div class="settings-actions">
            <button class="btn btn-secondary" id="cancel-settings">Annuler</button>
            <button class="btn btn-primary" id="apply-settings">Appliquer</button>
        </div>
    </div>

    <!-- Scripts externes avec gestion d'erreurs am√©lior√©e -->
    <script>
        console.log('üöÄ D√©but chargement des scripts...');
        
        // Variables globales pour le suivi du chargement
        window.scriptLoadStatus = {
            three: false,
            tween: false,
            gltfLoader: false
        };
        
        // Fonction utilitaire pour charger des scripts de mani√®re s√©quentielle
        function loadScript(src, name) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log(`‚úÖ ${name} charg√©`);
                    window.scriptLoadStatus[name.toLowerCase()] = true;
                    resolve();
                };
                script.onerror = () => {
                    console.error(`‚ùå Erreur chargement ${name}`);
                    reject(new Error(`Failed to load ${name}`));
                };
                document.head.appendChild(script);
            });
        }
        
        // Chargement s√©quentiel des d√©pendances
        async function loadExternalLibraries() {
            try {
                // Chargement de Three.js
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js', 'Three');
                
                // Chargement de Tween.js (optionnel)
                try {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js', 'Tween');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Tween.js non charg√©, continuons sans...');
                }
                
                // Chargement de GLTFLoader avec plusieurs tentatives
                const gltfLoaderUrls = [
                    'https://threejs.org/examples/js/loaders/GLTFLoader.js',
                    'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js',
                    'https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js'
                ];
                
                let gltfLoaded = false;
                for (const url of gltfLoaderUrls) {
                    try {
                        await loadScript(url, 'GLTFLoader');
                        gltfLoaded = true;
                        window.GLTFLoaderReady = true;
                        break;
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Tentative GLTFLoader √©chou√©e: ${url}`);
                    }
                }
                
                if (!gltfLoaded) {
                    console.error('‚ùå Impossible de charger GLTFLoader depuis toutes les sources');
                }
                
                console.log('üéâ D√©pendances externes charg√©es');
                return true;
                
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des d√©pendances:', error);
                return false;
            }
        }
        
        // D√©marrer le chargement
        loadExternalLibraries().then(() => {
            console.log('üìö Pr√™t pour les scripts Avatar');
        });
    </script>

    <!-- Scripts de l'avatar - ORDRE IMPORTANT avec gestion d'erreurs -->
    <script th:src="@{/js/avatar/avatar-config.js}" 
            onerror="console.error('‚ùå Erreur chargement avatar-config.js')"></script>
    <script th:src="@{/js/avatar/avatar-renderer.js}" 
            onerror="console.error('‚ùå Erreur chargement avatar-renderer.js')"></script>
    <script th:src="@{/js/avatar/avatar-animation.js}" 
            onerror="console.error('‚ùå Erreur chargement avatar-animation.js')"></script>
    <script th:src="@{/js/avatar/avatar-websocket.js}" 
            onerror="console.error('‚ùå Erreur chargement avatar-websocket.js')"></script>
    <script th:src="@{/js/avatar/avatar-controller.js}" 
            onerror="console.error('‚ùå Erreur chargement avatar-controller.js')"></script>
    <script th:src="@{/js/avatar/ready-player-me.js}" 
            onerror="console.error('‚ùå Erreur chargement ready-player-me.js')"></script>
	<script th:src="@{/js/avatar/avatar-debug.js}"
			onerror="console.error('‚ùå Erreur chargement avatar-debug.js')"></script>
		<script th:src="@{/js/speech-recognition.js}" 
		        onerror="console.error('‚ùå Erreur chargement speech-recognition.js')"></script>
		<script th:src="@{/js/wake-word-detector.js}" 
		        onerror="console.error('‚ùå Erreur chargement wake-word-detector.js')"></script>
    
    <!-- Script principal - AngelAvatarApp -->
    <script th:src="@{/js/avatar/avatar-main.js}" 
            onerror="console.error('‚ùå Erreur chargement avatar-main.js')"></script>

    <!-- Configuration et initialisation -->
    <script type="text/javascript">
        // Configuration Thymeleaf pour JavaScript
        window.ANGEL_CONFIG = {
            contextPath: /*[[${contextPath ?: '/'}]]*/ '/',
            pageTitle: /*[[${pageTitle ?: 'Angel Virtual Assistant'}]]*/ 'Angel Virtual Assistant',
            avatarEnabled: /*[[${avatarEnabled ?: true}]]*/ true,
            debug: true
        };

        // API globale pour l'int√©gration
        window.AngelAvatar = {
            speak: (text, emotion = 'neutral') => {
                console.log(`üó£Ô∏è AngelAvatar.speak: "${text}" (${emotion})`);
                
                if (window.angelApp && typeof window.angelApp.speak === 'function') {
                    window.angelApp.speak(text, emotion);
                } else {
                    console.warn('‚ö†Ô∏è AngelApp non disponible pour speak()');
                }
            },
            
            setEmotion: (emotion, intensity = 1.0) => {
                console.log(`üòä AngelAvatar.setEmotion: ${emotion} (${intensity})`);
                
                if (window.angelApp && typeof window.angelApp.setEmotion === 'function') {
                    window.angelApp.setEmotion(emotion, intensity);
                } else {
                    console.warn('‚ö†Ô∏è AngelApp non disponible pour setEmotion()');
                }
            },
            
            show: () => {
                console.log('üëÅÔ∏è AngelAvatar.show');
                if (window.angelApp && typeof window.angelApp.showAvatar === 'function') {
                    window.angelApp.showAvatar();
                } else {
                    console.warn('‚ö†Ô∏è AngelApp non disponible pour show()');
                }
            },
            
            hide: () => {
                console.log('üôà AngelAvatar.hide');
                if (window.angelApp && typeof window.angelApp.hideAvatar === 'function') {
                    window.angelApp.hideAvatar();
                } else {
                    console.warn('‚ö†Ô∏è AngelApp non disponible pour hide()');
                }
            },
            
            // Fonction de diagnostic
            getStatus: () => {
                return {
                    angelAppLoaded: !!window.angelApp,
                    angelAppInitialized: window.angelApp?.isInitialized || false,
                    scriptStatus: window.scriptLoadStatus,
                    threeLoaded: typeof THREE !== 'undefined',
                    gltfLoaderReady: window.GLTFLoaderReady || false
                };
            }
        };

        // Gestion des erreurs globales am√©lior√©e
        window.addEventListener('error', function(event) {
            console.error('‚ùå Erreur JavaScript globale:', event.error);
            
            // Afficher une notification d'erreur discr√®te
            if (event.error && event.error.message && !event.error.message.includes('Script error')) {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(244, 67, 54, 0.9);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 5px;
                    z-index: 9999;
                    max-width: 300px;
                    font-size: 14px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                `;
                errorDiv.innerHTML = `
                    <strong>Erreur Avatar</strong><br>
                    ${event.error.message}
                    <div style="margin-top: 5px; font-size: 12px; opacity: 0.8;">
                        Cliquez pour fermer
                    </div>
                `;
                
                errorDiv.onclick = () => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                };
                
                document.body.appendChild(errorDiv);
                
                // Auto-suppression apr√®s 8 secondes
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 8000);
            }
        });

        // Log de debug pour v√©rifier le chargement
        console.log('üé≠ Template avatar.html charg√©');
        console.log('üì¶ Configuration:', window.ANGEL_CONFIG);
        console.log('üîß AngelAvatar API disponible:', typeof window.AngelAvatar);
        
        // Fonction utilitaire pour diagnostiquer les probl√®mes
        window.diagnoseAvatar = () => {
            const status = window.AngelAvatar.getStatus();
            console.log('üîç Diagnostic Avatar:', status);
            return status;
        };
    </script>
	
	<!-- Initialisation de la reconnaissance vocale -->
	<script type="text/javascript">
	// Variables globales pour la reconnaissance vocale
	let wakeWordDetector = null;

	// Fonction pour initialiser la reconnaissance vocale
	async function initializeVoiceRecognition() {
	    console.log('üé§ Initialisation de la reconnaissance vocale...');
	    
	    if (!checkBrowserCompatibility()) {
	        showBrowserWarning();
	        return false;
	    }
	    
	    try {
	        wakeWordDetector = new WakeWordDetector();
	        
	        // Attendre que l'initialisation soit termin√©e
	        await wakeWordDetector.initialize();
	        
	        console.log('‚úÖ D√©tecteur de mot-cl√© pr√™t');
	        setupVoiceControls();
	        
	        return true;
	    } catch (error) {
	        console.error('‚ùå Erreur initialisation reconnaissance vocale:', error);
	        return false;
	    }
	}
	
	// V√©rification de compatibilit√© navigateur
	function checkBrowserCompatibility() {
	    const hasWebSocket = 'WebSocket' in window;
	    const hasSpeechRecognition = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
	    const hasMediaDevices = 'mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices;
	    
	    console.log('üîç Compatibilit√©:', {
	        webSocket: hasWebSocket,
	        speechRecognition: hasSpeechRecognition,
	        mediaDevices: hasMediaDevices
	    });
	    
	    return hasWebSocket && hasSpeechRecognition && hasMediaDevices;
	}

	// Affichage avertissement compatibilit√©
	function showBrowserWarning() {
	    const warning = document.getElementById('browser-warning');
	    if (warning) {
	        warning.style.display = 'block';
	    }
	}

	// Configuration des contr√¥les vocaux
	function setupVoiceControls() {
	    // Bouton d√©marrer
	    const startBtn = document.getElementById('start-listening');
	    if (startBtn) {
	        startBtn.addEventListener('click', () => {
	            if (wakeWordDetector) {
	                wakeWordDetector.startListening();
	            }
	        });
	    }
	    
	    // Bouton arr√™ter
	    const stopBtn = document.getElementById('stop-listening');
	    if (stopBtn) {
	        stopBtn.addEventListener('click', () => {
	            if (wakeWordDetector) {
	                wakeWordDetector.stopListening();
	            }
	        });
	    }
	    
	    // Bouton param√®tres
	    const settingsBtn = document.getElementById('voice-settings');
	    if (settingsBtn) {
	        settingsBtn.addEventListener('click', () => {
	            const panel = document.getElementById('voice-settings-panel');
	            if (panel) {
	                panel.classList.toggle('open');
	            }
	        });
	    }
	    
	    // Fermer param√®tres
	    const closeBtn = document.getElementById('close-settings');
	    if (closeBtn) {
	        closeBtn.addEventListener('click', () => {
	            const panel = document.getElementById('voice-settings-panel');
	            if (panel) {
	                panel.classList.remove('open');
	            }
	        });
	    }
	    
	    // Slider confiance
	    const slider = document.getElementById('confidence-slider');
	    const valueSpan = document.getElementById('confidence-value');
	    if (slider && valueSpan) {
	        slider.addEventListener('input', (e) => {
	            valueSpan.textContent = e.target.value;
	            updateVoiceConfig();
	        });
	    }
	    
	    // Autres contr√¥les
	    ['wake-word-input', 'language-select', 'continuous-listening', 'debug-mode'].forEach(id => {
	        const element = document.getElementById(id);
	        if (element) {
	            element.addEventListener('change', updateVoiceConfig);
	        }
	    });
	}

	// Mise √† jour configuration vocale
	function updateVoiceConfig() {
	    if (!wakeWordDetector || !wakeWordDetector.speechService) return;
	    
	    const config = {
	        wakeWord: document.getElementById('wake-word-input')?.value || 'Angel',
	        language: document.getElementById('language-select')?.value || 'fr-FR',
	        confidenceThreshold: parseFloat(document.getElementById('confidence-slider')?.value || '0.7'),
	        continuous: document.getElementById('continuous-listening')?.checked !== false
	    };
	    
	    wakeWordDetector.speechService.updateConfig(config);
	    console.log('üîß Configuration vocale mise √† jour:', config);
	}

	// Fonction de nettoyage
	function cleanupVoiceRecognition() {
	    if (wakeWordDetector) {
	        wakeWordDetector.destroy();
	        wakeWordDetector = null;
	    }
	}

	// Extension de l'API AngelAvatar
	window.AngelAvatar.voice = {
	    start: () => wakeWordDetector?.startListening(),
	    stop: () => wakeWordDetector?.stopListening(),
	    getStatus: () => wakeWordDetector?.getStatus(),
	    isSupported: () => checkBrowserCompatibility()
	};

	// Initialisation au chargement de la page
	document.addEventListener('DOMContentLoaded', function() {
	    console.log('üìÑ DOM charg√©, initialisation reconnaissance vocale...');
	    
	    // Attendre un peu que tout soit charg√©
	    setTimeout(() => {
	        initializeVoiceRecognition();
	    }, 1000);
	});

	// Nettoyage √† la fermeture
	window.addEventListener('beforeunload', () => {
	    cleanupVoiceRecognition();
	});

	console.log('üé≠ Extensions vocales ajout√©es √† avatar.html');
	</script>
</body>
</html>
