<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle ?: 'Angel Virtual Assistant'}">Angel Virtual Assistant</title>
    
    <!-- Styles extraits dans un fichier CSS s√©par√© -->
    <link rel="stylesheet" th:href="@{/css/avatar.css}">
    
    <!-- Meta tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Interface web pour Angel Virtual Assistant">
</head>
<body>
    <!-- Container principal de l'avatar -->
    <div id="avatar-container">
        <!-- Zone de rendu 3D -->
        <div id="avatar-viewport">
            <div class="loading-spinner" id="loading-spinner"></div>
            <div class="speaking-indicator" id="speaking-indicator"></div>
        </div>

        <!-- Bulle de message -->
        <div id="message-bubble">
            <p id="message-text">Bonjour ! Je suis Angel, votre assistant virtuel.</p>
        </div>

        <!-- Contr√¥les de l'avatar -->
        <div id="avatar-controls">
            <button class="control-button" id="mute-btn" title="Couper/Activer le son">
                üîä
            </button>
            
            <div id="avatar-status">En attente...</div>
            
            <button class="control-button" id="settings-btn" title="Param√®tres">
                ‚öôÔ∏è
            </button>
        </div>
    </div>

    <!-- Overlay pour les param√®tres -->
    <div id="settings-overlay"></div>

    <!-- Panneau de param√®tres -->
    <div id="avatar-settings">
        <h3 class="settings-title">Configuration de l'Avatar</h3>
        
        <div class="setting-group">
            <label class="setting-label" for="gender-select">Genre :</label>
            <select class="setting-select" id="gender-select">
                <option value="female">Femme</option>
                <option value="male">Homme</option>
            </select>
        </div>
        
        <div class="setting-group">
            <label class="setting-label" for="age-select">√Çge :</label>
            <select class="setting-select" id="age-select">
                <option value="25">25 ans</option>
                <option value="30" selected>30 ans</option>
                <option value="35">35 ans</option>
                <option value="40">40 ans</option>
                <option value="50">50 ans</option>
                <option value="60">60 ans</option>
            </select>
        </div>
        
        <div class="setting-group">
            <label class="setting-label" for="style-select">Style :</label>
            <select class="setting-select" id="style-select">
                <option value="casual" selected>D√©contract√©</option>
                <option value="professional">Professionnel</option>
                <option value="friendly">Amical</option>
                <option value="elegant">√âl√©gant</option>
            </select>
        </div>
        
        <div class="setting-group">
            <label class="setting-label" for="voice-select">Voix :</label>
            <select class="setting-select" id="voice-select">
                <option value="female_french_warm" selected>Femme - Chaleureuse</option>
                <option value="female_french_professional">Femme - Professionnelle</option>
                <option value="male_french_warm">Homme - Chaleureux</option>
                <option value="male_french_professional">Homme - Professionnel</option>
            </select>
        </div>
        
        <div class="settings-actions">
            <button class="btn btn-secondary" id="cancel-settings">Annuler</button>
            <button class="btn btn-primary" id="apply-settings">Appliquer</button>
        </div>
    </div>

    <!-- Scripts externes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    
    <!-- GLTFLoader -->
    <script>
        // Chargement du GLTFLoader de mani√®re compatible
        (function() {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/loaders/GLTFLoader.js';
            script.onload = function() {
                console.log('‚úÖ GLTFLoader charg√©');
            };
            script.onerror = function() {
                console.error('‚ùå Erreur chargement GLTFLoader');
            };
            document.head.appendChild(script);
        })();
    </script>

    <!-- Scripts de l'avatar - ORDRE IMPORTANT -->
    <script th:src="@{/js/avatar/avatar-config.js}" 
            onerror="console.error('‚ùå Erreur chargement avatar-config.js')"></script>
    <script th:src="@{/js/avatar/avatar-renderer.js}" 
            onerror="console.error('‚ùå Erreur chargement avatar-renderer.js')"></script>
    <script th:src="@{/js/avatar/avatar-animation.js}" 
            onerror="console.error('‚ùå Erreur chargement avatar-animation.js')"></script>
    <script th:src="@{/js/avatar/avatar-websocket.js}" 
            onerror="console.error('‚ùå Erreur chargement avatar-websocket.js')"></script>
    <script th:src="@{/js/avatar/avatar-controller.js}" 
            onerror="console.error('‚ùå Erreur chargement avatar-controller.js')"></script>
    <script th:src="@{/js/avatar/ready-player-me.js}" 
            onerror="console.error('‚ùå Erreur chargement ready-player-me.js')"></script>
    
    <!-- Script principal - AngelAvatarApp extrait du HTML -->
    <script th:src="@{/js/avatar/avatar-main.js}" 
            onerror="console.error('‚ùå Erreur chargement avatar-main.js')"></script>

    <!-- Configuration et initialisation -->
    <script type="text/javascript">
        // Configuration Thymeleaf pour JavaScript
        window.ANGEL_CONFIG = {
            contextPath: /*[[${contextPath ?: '/'}]]*/ '/',
            pageTitle: /*[[${pageTitle ?: 'Angel Virtual Assistant'}]]*/ 'Angel Virtual Assistant',
            avatarEnabled: /*[[${avatarEnabled ?: true}]]*/ true,
            debug: true
        };

        // API globale pour l'int√©gration (extrait du HTML original)
        window.AngelAvatar = {
            speak: (text, emotion = 'neutral') => {
                console.log(`üó£Ô∏è AngelAvatar.speak: "${text}" (${emotion})`);
                
                if (window.angelApp && window.angelApp.avatarRenderer) {
                    window.angelApp.showMessage(text);
                    window.angelApp.setSpeakingIndicator(true);
                    window.angelApp.updateStatus('Parle...');
                    
                    // Simulation - remplacer par vraie int√©gration
                    setTimeout(() => {
                        window.angelApp.setSpeakingIndicator(false);
                        window.angelApp.updateStatus('Pr√™t');
                        window.angelApp.hideMessage();
                    }, 3000);
                } else {
                    console.warn('‚ö†Ô∏è AngelApp non disponible');
                }
            },
            
            setEmotion: (emotion, intensity = 1.0) => {
                console.log(`üòä AngelAvatar.setEmotion: ${emotion} (${intensity})`);
                
                if (window.angelApp && window.angelApp.avatarRenderer && window.angelApp.avatarRenderer.setEmotion) {
                    window.angelApp.avatarRenderer.setEmotion(emotion, intensity);
                } else {
                    console.warn('‚ö†Ô∏è setEmotion non disponible');
                }
            },
            
            show: () => {
                console.log('üëÅÔ∏è AngelAvatar.show');
                if (window.angelApp && window.angelApp.showAvatar) {
                    window.angelApp.showAvatar();
                }
            },
            
            hide: () => {
                console.log('üôà AngelAvatar.hide');
                if (window.angelApp && window.angelApp.hideAvatar) {
                    window.angelApp.hideAvatar();
                }
            }
        };

        // Gestion des erreurs globales
        window.addEventListener('error', function(event) {
            console.error('‚ùå Erreur JavaScript globale:', event.error);
            
            // Optionnel : afficher une notification d'erreur √† l'utilisateur
            if (event.error && event.error.message) {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #f44336;
                    color: white;
                    padding: 10px;
                    border-radius: 5px;
                    z-index: 9999;
                    max-width: 300px;
                    font-size: 14px;
                `;
                errorDiv.textContent = `Erreur: ${event.error.message}`;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 5000);
            }
        });

        // Log de debug pour v√©rifier le chargement
        console.log('üé≠ Template avatar.html charg√©');
        console.log('üì¶ Configuration:', window.ANGEL_CONFIG);
        console.log('üîß AngelAvatar API disponible:', typeof window.AngelAvatar);
    </script>
</body>
</html>