<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle ?: 'Angel Virtual Assistant'}">Angel Virtual Assistant</title>
    
    <!-- Styles CSS organis√©s -->
    <link rel="stylesheet" th:href="@{/css/avatar.css}">
    <link rel="stylesheet" th:href="@{/css/wake-word-detector.css}">
    <link rel="stylesheet" th:href="@{/css/voice-enhancements.css}">
    <link rel="icon" type="image/x-icon" th:href="@{/assets/images/favicon.ico}">
    
    <!-- Meta tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Interface web am√©lior√©e pour Angel Virtual Assistant avec √©coute continue">
</head>
<body class="avatar-fullscreen senior-mode" data-user-type="senior">
    <!-- Container principal de l'avatar -->
    <div id="avatar-container" class="smooth-transition">
        <!-- Zone de rendu 3D -->
        <div id="avatar-viewport">
            <div class="loading-spinner" id="loading-spinner"></div>
            <div class="speaking-indicator" id="speaking-indicator"></div>
        </div>

        <!-- Bulle de message -->
        <div id="message-bubble" class="smooth-transition">
            <p id="message-text">Bonjour ! Je suis Ang√®le, votre assistante virtuelle. Dites "Ang√®le" pour m'activer.</p>
        </div>

        <!-- Contr√¥les de l'avatar (cach√©s par d√©faut) -->
        <div id="avatar-controls" class="auto-hide">
            <button class="control-button" id="mute-btn" title="Couper/Activer le son">
                üîä
            </button>
            
            <div id="avatar-status">En √©coute...</div>
            
            <button class="control-button" id="settings-btn" title="Param√®tres">
                ‚öôÔ∏è
            </button>
        </div>
    </div>

    <!-- Interface vocale am√©lior√©e -->
    <div class="voice-interface auto-hide">
        <!-- Indicateur d'√©coute principal -->
        <div id="listening-indicator" class="listening-indicator listening" title="√âtat de reconnaissance vocale">
            üé§
        </div>
        
        <!-- Contr√¥les vocaux (cach√©s par d√©faut) -->
        <div class="voice-controls" style="display: none;">
            <button id="start-listening" class="voice-control-btn start" title="D√©marrer l'√©coute">
                ‚ñ∂Ô∏è
            </button>
            <button id="stop-listening" class="voice-control-btn stop" title="Arr√™ter l'√©coute">
                ‚èπÔ∏è
            </button>
            <button id="voice-settings" class="voice-control-btn settings" title="Param√®tres vocaux">
                ‚öôÔ∏è
            </button>
        </div>
    </div>

    <!-- Statut de reconnaissance vocale -->
    <div id="speech-status" class="speech-status listening">
        Initialisation de l'√©coute continue...
    </div>

    <!-- Scripts externes avec gestion d'erreurs -->
    <script>
        console.log('üöÄ D√©but chargement enhanced-avatar.html...');
        
        // Configuration globale
        window.ANGEL_CONFIG = {
            contextPath: /*[[${contextPath ?: '/'}]]*/ '/',
            pageTitle: /*[[${pageTitle ?: 'Angel Virtual Assistant'}]]*/ 'Angel Virtual Assistant',
            avatarEnabled: /*[[${avatarEnabled ?: true}]]*/ true,
            autoStartListening: true,
            hideControlsByDefault: true,
            seniorMode: true,
            debug: false
        };
        
        // Chargement des d√©pendances externes
        async function loadExternalLibraries() {
            try {
                // Three.js
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js', 'Three.js');
                
                // Tween.js (optionnel)
                try {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js', 'Tween.js');
                } catch (e) {
                    console.warn('‚ö†Ô∏è Tween.js non charg√©, continuons...');
                }
                
                console.log('‚úÖ D√©pendances externes charg√©es');
                return true;
                
            } catch (error) {
                console.error('‚ùå Erreur chargement d√©pendances:', error);
                return false;
            }
        }
        
        function loadScript(src, name) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log(`‚úÖ ${name} charg√©`);
                    resolve();
                };
                script.onerror = () => {
                    console.error(`‚ùå Erreur chargement ${name}`);
                    reject(new Error(`Failed to load ${name}`));
                };
                document.head.appendChild(script);
            });
        }
        
        // D√©marrer le chargement
        loadExternalLibraries();
    </script>

    <!-- Scripts de l'application (ordre important) -->
    <script th:src="@{/js/avatar/avatar-config.js}"></script>
    <script th:src="@{/js/avatar/avatar-renderer.js}"></script>
    <script th:src="@{/js/avatar/avatar-animation.js}"></script>
    <script th:src="@{/js/avatar/avatar-websocket.js}"></script>
    <script th:src="@{/js/avatar/avatar-controller.js}"></script>
    <script th:src="@{/js/avatar/ready-player-me.js}"></script>
    <script th:src="@{/js/avatar/avatar-debug.js}"></script>
    
    <!-- Scripts vocaux existants -->
    <script th:src="@{/js/speech-recognition.js}"></script>
    <script th:src="@{/js/wake-word-detector.js}"></script>
    
    <!-- Scripts vocaux am√©lior√©s -->
    <script th:src="@{/js/voice/enhanced-speech-integration.js}"></script>
    <script th:src="@{/js/voice/continuous-voice-manager.js}"></script>
    
    <!-- Script principal -->
    <script th:src="@{/js/avatar/avatar-main.js}"></script>

    <!-- Initialisation et configuration -->
    <script type="text/javascript">
        // API globale √©tendue
        window.AngelAvatar = window.AngelAvatar || {};
        
        // √âtendre l'API existante
        window.AngelAvatar.voice = {
            speak: (text, emotion = 'neutral') => {
                console.log(`üó£Ô∏è AngelAvatar.speak: "${text}" (${emotion})`);
                
                if (window.enhancedSpeechIntegration) {
                    return window.enhancedSpeechIntegration.speakWithQueue(text, emotion);
                } else if (window.avatarSpeech) {
                    return window.avatarSpeech.speak(text, emotion);
                } else {
                    console.warn('‚ö†Ô∏è Aucun syst√®me de synth√®se vocale disponible');
                    return Promise.resolve();
                }
            },
            
            startListening: () => {
                console.log('üé§ AngelAvatar.startListening');
                if (window.continuousVoiceManager) {
                    window.continuousVoiceManager.startContinuousListening();
                } else if (window.wakeWordDetector) {
                    window.wakeWordDetector.startListening();
                }
            },
            
            showControls: () => {
                console.log('üëÅÔ∏è AngelAvatar.showControls');
                if (window.continuousVoiceManager) {
                    window.continuousVoiceManager.showControls();
                }
            },
            
            hideControls: () => {
                console.log('üôà AngelAvatar.hideControls');
                if (window.continuousVoiceManager) {
                    window.continuousVoiceManager.hideControls();
                }
            }
        };
        
        // Gestion des erreurs am√©lior√©e
        window.addEventListener('error', function(event) {
            console.error('‚ùå Erreur JavaScript:', event.error);
            
            if (event.error && !event.error.message.includes('Script error')) {
                const errorNotification = document.createElement('div');
                errorNotification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 20px;
                    background: rgba(244, 67, 54, 0.95);
                    color: white;
                    padding: 12px 18px;
                    border-radius: 8px;
                    z-index: 10000;
                    max-width: 400px;
                    font-size: 14px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    cursor: pointer;
                `;
                errorNotification.innerHTML = `
                    <strong>‚ö†Ô∏è Erreur syst√®me</strong><br>
                    ${event.error.message}<br>
                    <small style="opacity: 0.8; margin-top: 5px; display: block;">Cliquez pour fermer</small>
                `;
                
                errorNotification.onclick = () => errorNotification.remove();
                document.body.appendChild(errorNotification);
                
                setTimeout(() => {
                    if (errorNotification.parentNode) {
                        errorNotification.remove();
                    }
                }, 10000);
            }
        });
        
        console.log('üé≠ Enhanced Avatar Template charg√©');
        console.log('üìä Configuration:', window.ANGEL_CONFIG);
    </script>
    
    <!-- Auto-d√©marrage de l'√©coute continue -->
    <script type="text/javascript">
        // D√©marrage automatique de l'√©coute continue
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM charg√©, pr√©paration auto-d√©marrage...');
            
            // Attendre que tous les syst√®mes soient charg√©s
            setTimeout(() => {
                if (window.ANGEL_CONFIG.autoStartListening) {
                    console.log('üé§ Auto-d√©marrage de l\'√©coute continue...');
                    
                    // V√©rifier les permissions microphone
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        navigator.mediaDevices.getUserMedia({ audio: true })
                            .then(() => {
                                console.log('‚úÖ Permission microphone accord√©e');
                                
                                // D√©marrer l'√©coute continue
                                if (window.continuousVoiceManager) {
                                    window.continuousVoiceManager.startContinuousListening();
                                } else {
                                    console.log('‚è≥ ContinuousVoiceManager pas encore pr√™t, retry...');
                                    setTimeout(() => {
                                        if (window.continuousVoiceManager) {
                                            window.continuousVoiceManager.startContinuousListening();
                                        }
                                    }, 2000);
                                }
                            })
                            .catch(error => {
                                console.warn('‚ö†Ô∏è Permission microphone refus√©e:', error);
                                
                                // Afficher un message √† l'utilisateur
                                const statusElement = document.getElementById('speech-status');
                                if (statusElement) {
                                    statusElement.textContent = 'üé§ Cliquez pour autoriser l\'acc√®s au microphone';
                                    statusElement.className = 'speech-status error';
                                    statusElement.onclick = () => {
                                        window.AngelAvatar.voice.startListening();
                                    };
                                }
                            });
                    }
                }
            }, 2000);
        });
        
        // Message de bienvenue apr√®s initialisation
        setTimeout(() => {
            if (window.AngelAvatar && window.ANGEL_CONFIG.autoStartListening) {
                const welcomeMessage = "Bonjour ! Je suis Ang√®le, votre assistante virtuelle. Je vous √©coute en permanence. Dites simplement 'Ang√®le' suivi de votre question.";
                
                // Attendre un peu pour que l'√©coute soit active
                setTimeout(() => {
                    window.AngelAvatar.voice.speak(welcomeMessage, 'friendly');
                }, 3000);
            }
        }, 5000);
        
        console.log('üöÄ Enhanced Avatar System pr√™t');
    </script>
</body>
</html>